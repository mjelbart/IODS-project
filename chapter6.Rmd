# Chapter 6: Analysis of longitudinal data

## 1. Analyses of Chapter 8 of MABS using the RATS data
Reading in the data, setting the Group and ID variables to be factors and checking the data.

The variables are as follows:

ID - the ID number of each rat

Group - which of three different diets each rat was on

WD - day of measurement starting with the first day as 1

Weight - the body weight of the rat in grams

Time - as WD above but as an integer (with WD removed from the start)

```{r}
RATSL <- read.csv("data/RATSL.csv", sep = ",")
RATSL$Group <- factor(RATSL$Group)
RATSL$ID <- factor(RATSL$ID)

names(RATSL)

# Look at the structure of rats
str(RATSL)

# Print out summaries of the variables
summary(RATSL)
```


The following methods are for inital exploration and inital analysis of this longitudinal dataset.

## Graphs or analysis results 
These graphs can provide insights into the interesting patters of response over time and the structure of treatment differences. They can also help identify possible outliying observaitons. 
We're tryign to expose patterns in the data with the following guidlines in mind:
- show as much raw data as possible
- highlight aggregate pattersns
- identify both corss-sectional and longitudinal patterns
- try to make the idenification fon unsual individuals or unusual observations simple

### Preliminary assessment:
Below is a plot of the weight values for all rats over time differentiating between the three groups by line type (unbroken, dotted and dashed). Some observations from the plot: 

 - The generally increases over the period of the study.  

 - The rats in groups 2 and 3 have much heavier weights than those in group 1 and also increase in weight over the period of the study by much more than those in group 1.

```{r, include=FALSE}
library(dplyr, tidyr)
library(ggplot2)
```

```{r, fig.width=10, fig.height=10, warning=FALSE}

# Draw the plot of measures of weight over time
ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) + scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) + scale_y_continuous(name = "Weight (grams)") + theme(legend.position = "top")

```

### Standardized values
Looking at the tracking phenomenon through a plot of standardized values (i.e. the values obtaine dby subtracting the relevant occasionan mean from the original obeservaiton then dividing by the corresponding weight measure standard deviation).

That's what the plot below is meant to show something about but I'm not clear on what it's telling me. Page 158 of Kimmo's book may tell mem more or 'The Golden Standardise' section of Data Camp.
```{r}
# Standardise the variable bprs using the above equation
RATSL <- RATSL %>%
  group_by(Time) %>%
  mutate(stdweight = (Weight - mean(Weight))/sd(Weight)) %>%
  ungroup()
 
# Glimpse the data
glimpse(RATSL)
 
# Plot again with the standardised bprs
ggplot(RATSL, aes(x = Time, y = stdweight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ Group, labeller = label_both) +
  scale_y_continuous(name = "standardized rat weights")
```

### Summary Graphs
"With large numbers of observations, graphical displays of individual response profiles are of little use and investigators then commonly produce graphs showing average (mean) profiles for each treatment group along with some indication of the variation of the observations at each time point, in this case the standard error of mean"

"Standard deviation is a measure of dispersion of the data from the mean whereas standard error of the mean is a measure of how precise is our estimate of the mean.
For normally distributed data the standard deviation has some extra information, namely the 68-95-99.7 rule which tells us the percentage of data lying within 1, 2 or 3 standard deviation from the mean."

We can see in the plot below that there is a considerable gap between the mean profiles of the three groups suggesting significant difference between the groups with respect to the mean Weight values.

```{r}
# Number of weeks, baseline (week 0) included
n <- RATSL$Time %>% unique() %>% length()
 
# Summary data with mean and standard error of bprs by treatment and week 
RATSS <- RATSL %>%
  group_by(Group, Time) %>%
  summarise( mean = mean(Weight), se = sd(Weight)/sqrt(n) ) %>%
  ungroup()
 
# Glimpse the data
glimpse(RATSS)
 
# Plot the mean profiles
ggplot(RATSS, aes(x = Time, y = mean, linetype = Group, shape = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2)) +
  #geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.8,0.8)) +
  scale_y_continuous(name = "mean(Weight) +/- se(Weight)")

```

### Side by Side box plots
Side by side box plots of the observatsion at each time point.
Identify Outliers
and general increase in weight values over the study period for all groups
```{r}
# dplyr, tidyr & ggplot2 packages and BPRSL are available
 
# Create a summary data by treatment and subject with mean as the summary variable (ignoring baseline week 0).
RATSL8S <- RATSL %>%
  filter(Time > 0) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(Weight) ) %>%
  ungroup()
 
# Glimpse the data
glimpse(RATSL8S)
summary(RATSL8S)
 
# Draw a boxplot of the mean versus treatment
ggplot(RATSL8S, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight), over time")
 
# Create a new data by filtering the outlier and adjust the ggplot code the draw the plot again with the new data
RATSL8S1 <- filter(RATSL8S, RATSL8S$mean < 70)
 
 
# Glimpse the data
glimpse(RATSL8S1)
 
# Draw a boxplot of the mean versus treatment
ggplot(RATSL8S1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight), over time")

```

### Summary Measure Analysis I THINK THIS GOES WITH THE ABOVE
"The summary measure method operatees by transforming the repeatd measuremets made on each individual in the study into a single value that captures some essential feature of the indiviudua'ls respones over time."

The summary measure that is most relevant to teh particular questions fo interest in the study
I'm not sure what the particular questions of interest in this study are which is usually what informs the selection fo a summary measure. So in this case I've chosen the recommend e done of 'average response to treatment over time'

The mean of weight across weighing instances 2 to 64 will be chosen as the summary measure.
I will first calculate this measure, then look at boxplots of the measure for each treatment group.

 - """""The diagram below indicates that the mean summary measure is more varaibel in the second treatment group and its distribution in this group is somewhat skew"""""

 - """""The boxplotof the esecodn group reveals an outlier, a subject whose mean Weight score oveof the time period is over XXXXXXX. This might bias the conclusions fro further comparisons of groups so I will remove that subject from the data and create a new boxplot.
 
 - """""Without the outlier the mean of the second Group is lower than that of the first group - evidence of a difference in the summary of the measure distributions fo the groups.
 

### A formal test for difference
A t-test to assess any difference between teh groups.
Also calculation of a confience interval for this difference.
This is done using the data without teh outlier revealed earleir.
Prsented in teh tabel below.
The t-test confirms the presence of a difference between groups. THe 95% confidence interval is thin and doesn't include the zero, backing up this conclusion.

""""""Baseline measurements of the outcome variable in a longitudinal study are often correlated with the chosen summary measure and using such measures in the analysis can often lead to substantial gains in precision when used appropriately as a covariate in an analysis of covariance. We can illustrate the analysis on the data using the BPRS value corresponding to time zero taken prior to the start of treatment as the baseline covariate. We see that the baseline BPRS is strongly related to the BPRS values taken after treatment has begun, but there is still no evidence of a treatment difference even after conditioning on the baseline value."""""

Comparing the below to the boxplots of the summary measure analysis we can see....

```{r}
# A two-sample t-test
t.test(mean ~ Group, data = RATSL8S1, var.equal = TRUE)
 
# Adding the baseline from the original data as a new variable to the summary data
RATSL8S2 <- RATSL8S %>%
  mutate(baseline = RATS$WD1)
 
# Fitting the linear model with the mean as the response/target and baseline + treatment as the response from the RATSL8S1 
fit <- lm(mean ~ baseline + Group, data = RATSL8S2)
 
# Compute the analysis of variance table for the fitted model with anova() and pay close attention to the significance of baseline
anova(fit)

```


### Missing values
Chapter 8 of MABS for IODS includes a section on dealign with missing values but the following check indicates that our data has no missing values.

```{r}
summary(complete.cases(RATSL))
```

### Final Interpretations





## 2. Analyses of Chapter 9 of MABS using the BPRS data.
We want a model that can both assess the effects of explanatory variables on the multiple measures of the response variabel and caccount for the tlikley correatlation sbetween these multiple measures.

We're looking to "chracterize chang ein the repated values of the response variable and to determin the explaatory variabels most associated wth any change"

The below analysis is a more complete and more apprporaite for longituidnal data than section 1 above. We will fit a "suitable model to the data and estimate parameters that link the expatory vairables of interest to teh repeated measure sof the response variable"

### Graphs or analysis results
### Interpretations

```{r}
BPRSL <- read.csv("data/BPRSL.csv", sep = ",")

BPRSL$treatment <- factor(BPRSL$treatment)
BPRSL$subject <- factor(BPRSL$subject)

str(BPRSL)

summary(complete.cases(BPRSL))
```

### Fitting the Independence Model to the BPRS data
```{r}
# Check the dimensions of the data
dim(BPRSL)
 
# Plot the RATSL data
ggplot(BPRSL, aes(x = Time, y = treatment, group = subject)) +
  geom_line(aes(linetype = Group)) + scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) + scale_y_continuous(name = "Weight (grams)") + theme(legend.position = "top")

# ggplot(BPRSL, aes(x = week, y = bprs, linetype = subject)) +
#  geom_line() +
#  scale_linetype_manual(values = rep(1:10, times=4)) +
#  facet_grid(. ~ treatment, labeller = label_both) +
#  theme(legend.position = "none") + 
#  scale_y_continuous(limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))


```

### Fitting Linear Mixed Models to the BPRS data
```{r}
BPRSL
# create a regression model RATS_reg
BPRS_reg <- lm(bprs ~ week + treatment, BPRSL)
 
# print out a summary of the model
BPRS_reg

# a scatterplot matrix of the repeated measures of bprs
pairs(BPRSL[,1:4], pch = 19)
```

### Random Intercept and Random Slope Model
"Fitting a random intercept and random slope model allows the linear regression fits for each individual to differ in intercept, but also in slope. This way it is possible to account for the individual differences in the rats' growth profiles, but also the effect of time."

Looking at the chi-squared statistics and p-value of the likelihood ratio test between BPRS_ref1 and BPRS_ref we can see there isn't much difference. The lower the value the better the fit against the comparison model.


```{r}
library(lme4)
 
# create a random intercept and random slope model with Time and ID as the random effects
BPRS_ref1 <- lmer(bprs ~ week + treatment + (week | subject), data = BPRSL, REML = FALSE)
 
# print a summary of the model
summary(BPRS_ref1)

# perform an ANOVA test on the two models RATS_ref and RATS_ref1
anova(RATS_ref1, RATS_ref)

```

### Random Intercept and Random Slope Model with interaction

Here we do a random intercept and slope model that allows for a treatment × week interaction.
```{r}
# create a random intercept and random slope model with the interaction
RATS_ref2 <- lmer(Weight ~ Time * Group + (Time | ID), data = RATSL, REML = FALSE)
 
# print a summary of the model
summary(RATS_ref2)

# perform an ANOVA test on the two models
anova(RATS_ref2, RATS_ref1)

# draw the plot of RATSL with the observed Weight values
ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 20)) +
  scale_y_continuous(name = "Observed weight (grams)") +
  theme(legend.position = "top")

```

```{r}
# Create a vector of the fitted values
Fitted <- fitted(RATS_ref2)
 
# Create a new column fitted to RATSL
RATSL <- RATSL %>%
  mutate(Fitted)
 
# draw the plot of RATSL with the Fitted values of weight
ggplot(RATSL, aes(x = Time, y = Fitted, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 20)) +
  scale_y_continuous(name = "Fitted weight (grams)") +
  theme(legend.position = "top")

```



```{r, fig.width=10, fig.height=10, warning=FALSE}
```
